@if (ConnectedUsers is not null && ConnectedUsers.Count > 0)
{
    <div class="list-group list-group-flush">
        @foreach (var user in ConnectedUsers)
        {
            if (user.UserId != LogonUser)
            {
                var unreadCount = user.Messages
                .Count(m => m.Unread && m.FromUserId != LogonUser);

                <button type="button"
                        class="list-group-item list-group-item-action d-flex
                                           align-items-center justify-content-between py-2"
                        @key="user.ConnectionId"
                        @onclick="async () => await SelectUser(user.ConnectionId)">

                    <div class="d-flex align-items-center gap-2">
                        <!-- Avatar -->
                        <div class="rounded-circle text-white
                                                d-flex align-items-center justify-content-center"
                             style="width:36px;height:36px;background:linear-gradient(135deg, #0d6efd, #6f42c1);">
                            @user.UserName.Substring(0, 1).ToUpper()
                        </div>

                        <!-- Username -->
                        <span class="fw-semibold">@user.UserName</span>
                    </div>

                    @if (unreadCount > 0)
                    {
                        <span class="badge bg-danger rounded-pill px-2">
                            @unreadCount
                        </span>
                    }
                </button>
            }
        }
    </div>
}


@code {
	[Parameter]
	public string? LogonUser { get; set; }
	[Parameter]
	public List<ConnectedUser>? ConnectedUsers { get; set; }
	[Parameter]
	public EventCallback<ConnectedUser> OnUserSelected{ get; set; }

	public void CleaerUnreadMessageCount(string userId)
	{
		this.ConnectedUsers.Where(x => userId == this.LogonUser).
		FirstOrDefault()?.Messages.ForEach(m => m.Unread = false);
		StateHasChanged();
	}
	private async Task SelectUser(string connectionId)
	{
		var targetuser = ConnectedUsers?.FirstOrDefault(u => u.ConnectionId == connectionId);
		if(targetuser is not null)
		{
			targetuser.Messages.ForEach(m => {
				if (m.FromUserId != this.LogonUser)
				{
					m.Unread = false;
				}
			});
			await OnUserSelected.InvokeAsync(targetuser);
		}
		
	}


}
